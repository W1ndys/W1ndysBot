# wzryxmg（王者荣耀小马糕）功能模块

## 功能简介

本模块用于自动收集和管理群聊中的王者荣耀小马糕消息，支持高价小马糕查询和过期自动清理功能。

## 核心功能

### 1. 小马糕消息收集
- **触发条件**：模块开关开启 + 群聊消息匹配小马糕格式
- **消息格式**：`王者荣耀【xxxxxxxxxx】我的小马糕今天xxx块，复制链接来我的市集出售，马年上分大吉！`
- **去重规则**：相同的小马糕消息（完整内容）不重复存储
- **过期规则**：当天数据当天有效，次日自动失效

### 2. 高价小马糕查询
- **触发条件**：群聊消息包含"高价小马糕"
- **响应内容**：自动发送当天该群组价格最高的小马糕消息
- **附加提示**：`若该小马糕无额度，可回复本条消息删除该条数据`

### 3. 小马糕删除
- **触发条件**：引用机器人发送的高价小马糕消息，回复"删除"
- **处理流程**：
  1. 调用API获取被引用消息的内容
  2. 从消息内容中解析出小马糕代码
  3. 从数据库中删除对应记录

## 使用方法

### 开启/关闭模块
```
xmg
```
（需要系统管理员权限）

### 查询高价小马糕
```
高价小马糕
```

### 删除小马糕记录
1. 引用机器人发送的高价小马糕消息
2. 回复：`删除`

### 查看帮助
```
xmg/help
```

## 数据库表结构

**表名**：`xmg_records`

| 字段 | 类型 | 说明 |
|-----|-----|------|
| id | INTEGER | 主键，自增 |
| group_id | TEXT | 群号 |
| user_id | TEXT | 发送者QQ号 |
| nickname | TEXT | 发送者昵称 |
| full_message | TEXT | 完整的小马糕消息 |
| price | INTEGER | 小马糕价格 |
| store_date | TEXT | 存储日期(YYYY-MM-DD) |
| created_at | TIMESTAMP | 创建时间 |

**约束**：`UNIQUE(group_id, full_message, store_date)` - 相同消息每天只保留一条

## 技术说明

### Echo标记机制
由于WebSocket通信无法一对一获取API响应，删除功能使用echo标记+临时变量实现消息关联：
- **格式**：`key={uuid}_gid={group_id}_uid={user_id}_mid={message_id}`
- **用途**：在调用`get_msg` API时标记请求，响应时识别上下文

### 文件结构
```
app/modules/wzryxmg/
├── __init__.py              # 模块配置
├── main.py                  # 事件分发入口
├── DESIGN.md                # 详细设计文档
├── README.md                # 本文件
└── handlers/
    ├── data_manager.py      # 数据库管理
    ├── handle_message.py    # 消息事件分发
    ├── handle_message_group.py   # 群消息处理（核心）
    ├── handle_response.py   # 响应处理（删除功能）
    └── ...                  # 其他处理器（模板默认）
```
